<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>DapperContext by wcabus</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>DapperContext</h1>
          <h2>Dapper, but then with a EF-style DbContext supporting the Unit Of Work pattern and simplifying usage with repository classes and IOC containers. I hope. Oh, and unicorns.</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/wcabus/DapperContext/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/wcabus/DapperContext/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/wcabus/DapperContext" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <h1>
<a name="dappercontext" class="anchor" href="#dappercontext"><span class="octicon octicon-link"></span></a>DapperContext</h1>

<p>DapperContext is a DbContext-like implementation for Dapper, supporting the Unit Of Work pattern and simplifying usage with repository classes and IOC containers.</p>

<h2>
<a name="how-do-i-use-this-thing" class="anchor" href="#how-do-i-use-this-thing"><span class="octicon octicon-link"></span></a>How do I use this thing?</h2>

<p>Head over to the NuGet Package Manager inside Visual Studio and search for DapperContext (don't forget to change "Stable Only" into "Include Prerelease"), or add it to your project using the Package Manager Console window by typing:</p>

<p><code>

Install-Package DapperContext -IncludePrerelease

</code></p>

<p>NuGet will automatically fetch Dapper as well if you haven't already added this great lightweight ORM library to your project.</p>

<h2>
<a name="any-examples" class="anchor" href="#any-examples"><span class="octicon octicon-link"></span></a>Any examples?</h2>

<p>If you clone the repository or download the source code, you'll find that there is a WPF Client application project. This project demonstrates how to use DapperContext together with repository classes, and also demonstrates how to create and use a unit of work to group statements together in a single transaction.</p>
<p>This example uses the Northwind database, which you can find <a href="http://northwinddatabase.codeplex.com" target="_blank">here</a>. Please make sure to check if the connectionstring inside the the app.config file matches the situation on your PC when testing the example.</p>

<p>In short, each repository class derives from BaseRepository. In this class, there is only one method:</p>

<pre>
<code>
protected DbContext CreateContext()
{
    return new DbContext(ConfigurationManager.AppSettings["Database"]);
}
</code>
</pre>

<p>This method is being used to create a DbContext which will look at the Database appsetting value in the app.config file to determine which connectionstring setting will be used to connect to the database.<br/>
Then, a repository can call the Query method to perform a SELECT statement.<br/>
Since either Dapper or DapperContext opens and closes the connection only when necessary, you'll typically be reusing the same physical SQL connection from the connection pool. In some cases you might end up using multiple physical connections, especially so when performing multiple statements in a multi-threaded application.
</p>

<p>Inside the OrderService class, you can see the unit of work principle in action. When you add products to an order inside the application, the CreateOrder and CreateOrderDetail methods are being used to create the necessary instances and link them together.<br/>
When you finish and click the Save Order button, the SaveOrder method will be called:</p>

<pre>
<code>
public void SaveOrder(Order order)
{
    using (var context = CreateContext())
    {
        using (var scope = context.CreateUnitOfWork())
        {
            order.OrderID = context.Query<int>("" +
                        "INSERT INTO Orders (CustomerID, OrderDate) VALUES (@CustomerID, @OrderDate);" +
                        "SELECT CAST(SCOPE_IDENTITY() as int)",
                        new {order.CustomerID, OrderDate = order.OrderDate.Value}).Single();

            foreach (var line in order.Lines)
            {
                line.OrderID = order.OrderID;
                context.Execute("INSERT INTO [Order Details] (OrderID, ProductID, Discount, UnitPrice, Quantity) VALUES (@OrderID, @ProductID, @Discount, @UnitPrice, @Quantity)",
                    new { line.OrderID, line.ProductID, line.Discount, line.UnitPrice, line.Quantity });
            }

            scope.SaveChanges(); //And commit this unit of work
        }
    }
}
</code>
</pre>

<p>If this method throws an exception, then the line <c>scope.SaveChanges();</c> will not be executed and the unit of work will be rolled back when it reaches the end of the <c>using</c> block. An error will occur, in example, if the same product is being added twice to a single order. This happens because the Order Detail table in the Northwind database has a primary key constraint on both OrderID and ProductID.</p>

        </section>

        <footer>
          DapperContext is maintained by <a href="https://github.com/wcabus">wcabus</a><br>
          Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        
      </div>
    </div>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46801420-1', 'wcabus.github.io');
  ga('send', 'pageview');

</script>
  </body>
</html>
